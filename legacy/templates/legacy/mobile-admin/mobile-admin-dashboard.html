{% extends 'legacy/layout.html' %}

{% block extra_heads %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .admin-slot-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .admin-slot-card h3 {
      margin: 0 0 8px;
      font-size: 1.1em;
    }
    .admin-slot-verified {
      background-color: #2ecc71;
      border: 3px solid transparent;
    }

    #slots-table {
      border-spacing: 0;
    }

    /* table.admin-dashboard, .admin-slot-verified td, #slots-container {
      border: none;
    } */

    .admin-slot-pending {
      border-left: 4px solid #e67e22;
    }
    .admin-slot-card img {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
    }
    @media(min-width: 768px) {
      .admin-slot-card {
        display: none;
      }
      table.admin-dashboard {
        display: table;
        width: 100%;
      }
    }

    @media(max-width: 767px) {
      table.admin-dashboard {
        display: none;
      }
      .admin-slot-card {
        display: block;
      }
    }
  </style>
{% endblock %}

{% block title %}Admin Dashboard | Bytes of Legacy{% endblock %}

{% block content %}
  <div class="bol-body-title">
    Admin Dashboard
  </div>
  <form method="POST" action="{% url 'legacy:mobile-admin-logout' %}">
    {% csrf_token %}
    <button type="submit">Logout</button>
  </form>
  <div class="bol-body-content">
    <table id="slots-table" class="admin-dashboard">
      <thead>
        <tr>
          <th>Slot Number</th>
          <th>Name</th>
          <th>Payment Amount</th>
          <th>Claimed Date</th>
          <th>Admin Remarks</th>
          <th>Reference Number</th>
          <th>Payment Proof</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="slots-container">
        <!-- Desktop version rows -->
      </tbody>
    </table>
  </div>  

  <div id="mobile-slots-container">
    <!-- Mobile version cards -->
  </div>

  <!-- Modal for remarks -->
  <div id="admin-remarks-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Update Admin Remarks</h2>
      <form id="admin-remarks-form">
        <textarea name="admin_remarks" id="admin_remarks" rows="4" cols="50"></textarea><br>
        <button type="submit">Save Remarks</button>
      </form>
    </div>
  </div>

  <script>
    let selectedSlotId = null;

    function fetchUpdatedSlots() {
      $.ajax({
        url: '{% url "legacy:get_updated_slots" %}',
        method: 'GET',
        success: function(response) {
          $('#slots-container').empty();
          $('#mobile-slots-container').empty();

          response.slots.forEach(function(slot) {
            let verifiedClass = slot.verified ? 'admin-slot-verified' : 'admin-slot-pending';
            let proofUrl = `/proxy-payment-proof/?url=${encodeURIComponent(slot.payment_proof)}`;

            // Desktop row
            $('#slots-container').append(`
              <tr class="${verifiedClass}">
                <td>${slot.slot_number}</td>
                <td>${slot.name}</td>
                <td>${slot.payment_amount}</td>
                <td>${slot.claimed_date || 'Not Claimed'}</td>
                <td>${slot.admin_remarks || 'N/A'}</td>
                <td><input type="text" id="reference_number_${slot.id}" value="${slot.payment_reference_number || ''}" /></td>
                <td><img src="${proofUrl}" class="payment-proof-thumbnail" data-full-image="${proofUrl}" width="50"/></td>
                <td><button class="edit-remarks-btn" data-slot-id="${slot.id}" data-remarks="${slot.admin_remarks || ''}">Edit</button></td>
              </tr>
            `);

            // Mobile card
            $('#mobile-slots-container').append(`
              <div class="admin-slot-card ${verifiedClass}">
                <h3>Slot #${slot.slot_number}</h3>
                <p><strong>Name:</strong> ${slot.name}</p>
                <p><strong>Amount:</strong> ${slot.payment_amount}</p>
                <p><strong>Claimed:</strong> ${slot.claimed_date || 'Not Claimed'}</p>
                <p><strong>Remarks:</strong> ${slot.admin_remarks || 'N/A'}</p>
                <p><strong>Reference:</strong> ${slot.payment_reference_number || ''}</p>
                <img src="${proofUrl}" data-full-image="${proofUrl}" class="payment-proof-thumbnail" />
                <button class="edit-remarks-btn" data-slot-id="${slot.id}" data-remarks="${slot.admin_remarks || ''}">Edit Remarks</button>
              </div>
            `);
          });

          // Remarks click
          $('.edit-remarks-btn').click(function() {
            selectedSlotId = $(this).data('slot-id');
            $('#admin_remarks').val($(this).data('remarks') || '');
            $('#admin-remarks-modal').show();
          });

          // Full image modal
          $('.payment-proof-thumbnail').click(function() {
            openImageModal($(this).data('full-image'));
          });
        },
        error: function() {
          alert('Error fetching data.');
        }
      });
    }

    $('#admin-remarks-form').submit(function(e) {
      e.preventDefault();
      $.ajax({
        url: '{% url "legacy:update_admin_remarks" %}',
        method: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          slot_id: selectedSlotId,
          admin_remarks: $('#admin_remarks').val()
        },
        success: function() {
          $('#admin-remarks-modal').hide();
          fetchUpdatedSlots();
        }
      });
    });

    $('.modal .close').click(function() {
      $(this).closest('.modal').hide();
    });

    function openImageModal(url) {
      const modal = document.createElement('div');
      modal.className = 'image-modal';
      modal.innerHTML = `
        <div class="modal-content">
          <span class="close">&times;</span>
          <img src="${url}" style="width: 100%;" />
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector('.close').onclick = () => document.body.removeChild(modal);
    }

    fetchUpdatedSlots();
    setInterval(fetchUpdatedSlots, 60000);
  </script>
{% endblock %}